   Compiling stonescript-parser v0.2.0 (/Users/kurbezz/Projects/stonescript/stone-script-lsp/crates/stonescript-parser)
warning: type `ParseContext<'a>` is more private than the item `parse_program`
   --> crates/stonescript-parser/src/parser.rs:706:1
    |
706 | pub fn parse_program<'a>(input: &'a str, ctx: &ParseContext<'a>) -> IResult<&'a str, Program> {
    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ function `parse_program` is reachable at visibility `pub`
    |
note: but type `ParseContext<'a>` is only usable at visibility `pub(self)`
   --> crates/stonescript-parser/src/parser.rs:17:1
    |
 17 | struct ParseContext<'a> {
    | ^^^^^^^^^^^^^^^^^^^^^^^
    = note: `#[warn(private_interfaces)]` on by default

warning: `stonescript-parser` (lib) generated 1 warning
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.38s
     Running `target/debug/examples/debug_parse test_scripts/Games/Snake.txt`
Parsing: test_scripts/Games/Snake.txt
Content length: 10227 bytes
First 200 chars: "/*\r\nSnake\r\nv2.2.2\r\nSSRPG Version: 3.49.4\r\ninstruction:\r\n\timport Snake\r\n\r\nSupport mobile control via UI panel, store highest score permanently\r\nBigger food, smaller canvas->more comfortable game experi"

Parsing statement at offset 0
Parsing statement at offset 266
Parsing statement at offset 310
Parsing statement at offset 316
Parsing statement at offset 332
Parsing statement at offset 348
Parsing statement at offset 359
Parsing statement at offset 372
Parsing statement at offset 386
✗ Parse error: Failed to parse completely. Remaining: "= []\r\nvar titleText\r\nvar speedChooseText\r\nvar guideText\r\n\r\nvar height = screen.h - 2\r\nvar width = height\r\n\r\nvar loopStopTime = 0\r\nvar timer = 0\r\n\r\nvar space = []\r\n\r\nvar headX = width / 2\r\nvar headY = height / 2\r\n\r\nvar direction = 8\r\nvar currentDirection = 8\r\n\r\nvar initialLevel = 1\r\nvar currentLevel = 1\r\nvar speed = 10\r\n\r\nvar length = 0\r\nvar eaten = 0\r\n\r\nvar food = true\r\nvar foodX = headX\r\nvar foodY = headY\r\n\r\nvar body = []\r\nvar color = \"#FFFFFF\"\r\nvar ouroborosColor = [\"#FF0000\",\"#FF7F00\",\"#FFFF00\",\"#00FF00\",\"#00FFFF\",\"#0000FF\",\"#8B00FF\"]\r\nvar ouroboros = -1\r\n\r\nvar score = 0\r\nvar highestScore = storage.Get(\"snake_high\", 0)\r\nvar highestScoreX\r\n\r\nvar state = \"initialize\"\r\n\r\nvar cc = 0\r\n\r\n\r\n\r\n//////////////////////////////////\r\n//////////     main     //////////\r\n//////////////////////////////////\r\n\r\n\r\nfunc main()\r\n\t?loc.loop\r\n\t\tBuildUI()\r\n\t\t\r\n\t\t?body.Count()\r\n\t\t\tfor i = 0..body.Count() - 1\r\n\t\t\t\tshowCanvas.Set(body[i][0] * 2, body[i][1], color, \"o\")\r\n\t\tshowCanvas.Set(headX * 2, headY, color, \"O\")\r\n\r\n\t\t?string.Equals(state, \"title\")\r\n\t\t\ttitle()\r\n\t\t:?string.Equals(state, \"gameover\")\r\n\t\t\tgameover()\r\n\t\t:?string.Equals(state, \"playing\")\r\n\t\t\tsetConfirmButton(\"stop\")\r\n\t\t\tloopStopTime = 30\r\n\t\t\ttimer = 0\r\n\r\n\t?string.Equals(state, \"initialize\")\r\n\t\tBuildUI()\r\n\t\ttitle()\r\n\t\tfoodt.visible = false\r\n\t\tstate = \"title\"\r\n\t:?string.Equals(state, \"setupData\")\r\n\t\tfor i = 1..height\r\n\t\t\t?cc < width * height\r\n\t\t\t\t?cc ! getIndex(headX, headY)\r\n\t\t\t\t\tspace.Add(cc)\r\n\t\t\t\tcc++\r\n\t\t\t:\r\n\t\t\t\tsetFood()\r\n\t\t\t\tfoodt.visible = true\r\n\t\t\t\ttitleText.visible = false\r\n\t\t\t\tspeedChooseText.visible = false\r\n\t\t\t\tguideText.visible = false\r\n\t\t\t\tsetConfirmButton(\"stop\")\r\n\t\t\t\tstate = \"playing\"\r\n\t\t\t\tbreak\r\n\t:?string.Equals(state, \"playing\")\r\n\t\t?loopStopTime\r\n\t\t\tloopStopTime--\r\n\t\t\t>c0,0,@loopStopTime@\r\n\t\t:\r\n\t\t\tplaying()\r\n\t:?string.Equals(state, \"stop\")\r\n\t\t>c-3,0,s t o p\r\n\t:?string.Equals(state, \"gameover\")\r\n\t\t?ouroboros ! -1 & totaltime % 3 = 0\r\n\t\t\touroboros = (ouroboros + 1) % 7\r\n\t\t\tfor i = 0..body.Count() - 1\r\n\t\t\t\tshowCanvas.Set(body[i][0] * 2, body[i][1], ouroborosColor[(ouroboros + i) % 7], \"o\")\r\n\r\n\tdisplayScore()\r\n\tcheckInput()\r\n\t\r\n////////////////////////////////////////\r\n\r\n\r\nfunc BuildUI()\r\n\tmainWindow = ui.AddPanel()\r\n\tmainWindow.w = width * 2 + 2\r\n\tmainWindow.h = height + 2\r\n\tmainWindow.style = 3\r\n\t//mainWindow\r\n\r\n\tpnlCtrl = ui.AddPanel()\r\n\tpnlCtrl.w = 15\r\n\tpnlCtrl.h = 9\r\n\tpnlCtrl.x = 1\r\n\tpnlCtrl.y = 0\r\n\tpnlCtrl.style = 0\r\n\tpnlCtrl.anchor = center_left\r\n\tpnlCtrl.dock = center_left\r\n\tpnlCtrl.clip = true\r\n\tpnlCtrl.visible = true\r\n\t//mainWindow.Add(pnlCtrl)\r\n\r\n\tbuttonList.Clear()\r\n\r\n\tBuildConfirmButton()\r\n\tBuildArrowButton(5, 3, ascii\r\n#_\r\n| |\r\n\\_/\r\nasciiend)\r\n\tBuildArrowButton(0, 0, ascii\r\n#_\r\n/ |\r\n\\_|\r\nasciiend)\r\n\tBuildArrowButton(10, 0, ascii\r\n#_\r\n| \\\r\n|_/\r\nasciiend)\r\n\tBuildArrowButton(5, -3, ascii\r\n#_\r\n/ \\\r\n|_|\r\nasciiend)\r\n\tBuildShowCanvas()\r\n\tBuildTitleText()\r\n\tBuildSpeedChooseText()\r\n\tBuildguideText()\r\n\t\r\n\tfoodt = ui.AddText()\r\n\tfoodt.text = ascii\r\n#_\r\n(ʘ)\r\n#‾\r\nasciiend\r\n\tfoodt.w = 3\r\n\tfoodt.h = 3\r\n\tfoodt.x = foodX * 2\r\n\tfoodt.y = foodY\r\n\tfoodt.color = ouroborosColor[rng % 7]\r\n\tfoodt.anchor = top_left\r\n\tfoodt.dock = top_left\r\n\tmainWindow.Add(foodt)\r\n\r\n\thighestScoreX = mainWindow.absoluteX + mainWindow.w - numberLength(highestScore)\r\n\r\nfunc BuildConfirmButton()\r\n\tvar button = ui.AddButton()\r\n\tbutton.text = \"\"\r\n\tbutton.w = 5\r\n\tbutton.h = 3\r\n\tbutton.x = 5\r\n\tbutton.y = 0\r\n\tbutton.style = 0\r\n\tbutton.anchor = center_left\r\n\tbutton.dock = center_left\r\n\tbutton.SetPressed(buttonAction)\r\n\tbuttonList.Add(button)\r\n\tpnlCtrl.Add(button)\r\n\t\r\nfunc BuildFood(x, y, c)\r\n\tfoodt.x = x + 1\r\n\tfoodt.y = y\r\n\tfoodt.color = c\r\n\r\nfunc BuildArrowButton(x, y, t)\r\n\tvar button = ui.AddButton()\r\n\tbutton.text = \"\"\r\n\tbutton.w = 5\r\n\tbutton.h = 3\r\n\tbutton.x = x\r\n\tbutton.y = y\r\n\tbutton.tcolor = #EEEEEE\r\n\tbutton.bcolor = #666666\r\n\tbutton.hcolor = #999999\r\n\tbutton.style = 0\r\n\tbutton.anchor = center_left\r\n\tbutton.dock = center_left\r\n\tbutton.SetPressed(buttonAction)\r\n\tbuttonList.Add(button)\r\n\r\n\tvar text = ui.AddText()\r\n\ttext.text = t\r\n\ttext.w = 3\r\n\ttext.h = 3\r\n\ttext.x = x + 1\r\n\ttext.y = y\r\n\ttext.anchor = center_left\r\n\ttext.dock = center_left\r\n\r\n\tpnlCtrl.Add(button)\r\n\tpnlCtrl.Add(text)\r\n\r\nfunc BuildShowCanvas()\r\n\tshowCanvas = ui.AddCanvas()\r\n\tshowCanvas.w = mainWindow.w - 2\r\n\tshowCanvas.h = mainWindow.h - 2\r\n\tmainWindow.Add(showCanvas)\r\n\r\n\tshowCanvas.Set(headX * 2, headY, color, \"O\")\r\n\r\nfunc BuildTitleText()\r\n\ttitleText = ui.AddText()\r\n\ttitleText.w = mainWindow.w\r\n\ttitleText.h = 2\r\n\ttitleText.y = -mainWindow.h / 4\r\n\ttitleText.align = center\r\n\tmainWindow.Add(titleText)\r\n\r\nfunc BuildSpeedChooseText()\r\n\tspeedChooseText = ui.AddText()\r\n\tspeedChooseText.w = 9\r\n\tspeedChooseText.h = 2\r\n\tspeedChooseText.y = mainWindow.h / 8\r\n\tspeedChooseText.align = center\r\n\tmainWindow.Add(speedChooseText)\r\n\r\nfunc BuildguideText()\r\n\tguideText = ui.AddText()\r\n\tguideText.w = 18\r\n\tguideText.h = 1\r\n\tguideText.y = mainWindow.h / 4\r\n\tguideText.align = center\r\n\tmainWindow.Add(guideText)\r\n\r\nfunc buttonAction(btn)\r\n\t?buttonList[0] = btn\r\n\t\tconfirm()\r\n\t:\r\n\t\tfor i = 1..buttonList.Count() - 1\r\n\t\t\t?buttonList[i] = btn\r\n\t\t\t\t?string.Equals(state, \"title\") | string.Equals(state, \"gameover\")\r\n\t\t\t\t\tchangeInitialSpeed([-5,-1,1,5][i-1])\r\n\t\t\t\t:?string.Equals(state, \"playing\")\r\n\t\t\t\t\tsetDirection(i * 2)\r\n\t\t\t\tbreak\r\n\r\nfunc setSpeed()\r\n\t?eaten >= currentLevel * currentLevel * 10\r\n\t\tspeed = math.clamp(speed - 1, 1, 10)\r\n\t\tcurrentLevel = levelCalculation(speed)\r\n\r\nfunc reset()\r\n\ttimer = 0\r\n\t\r\n\theadX = width / 2\r\n\theadY = height / 2\r\n\tdirection = 8\r\n\tcurrentDirection = 8\r\n\tlength = 6\r\n\teaten = 0\r\n\t\r\n\tbody.Clear()\r\n\tcolor = \"#FFFFFF\"\r\n\t\r\n\tscore = 0\r\n\touroboros = -1\r\n\t\r\n\tcurrentLevel = initialLevel\r\n\tspeed = levelCalculation(initialLevel)\r\n\r\n\tshowCanvas.Set(\"#\")\r\n\tshowCanvas.Set(headX * 2, headY, color, \"O\")\r\n\r\n\tcc = 0\r\n\tspace.Clear()\r\n\tstate = \"setupData\"\r\n\r\n\r\n//////////     food     //////////\r\n\r\nfunc setFood()\r\n\tvar i\r\n\t?space.Count()\r\n\t\ti = space[rng % space.Count()]\r\n\t\tfoodX = i % width\r\n\t\tfoodY = (i - foodX) / width\r\n\t:\r\n\t\ti = body[0]\r\n\t\tfoodX = i[0]\r\n\t\tfoodY = i[1]\r\n\tBuildFood(foodX * 2, foodY, ouroborosColor[rng % 7])\r\n\r\n//////////     move     //////////\r\n\r\nfunc playing()\r\n\ttimer = (timer + 1) % speed\r\n\t?!timer\r\n\t\tbody.Add([headX, headY])\r\n\t\tshowCanvas.Set(headX * 2, headY, color, \"o\")\r\n\r\n\t\t?body.Count() > length\r\n\t\t\tvar x = body[0][0]\r\n\t\t\tvar y = body[0][1]\r\n\t\t\tspace.Add(getIndex(x, y))\r\n\t\t\tshowCanvas.Set(x * 2, y, \"#\")\r\n\t\t\tbody.RemoveAt(0)\r\n\r\n\t\t?direction = 2\r\n\t\t\theadY++\r\n\t\t\tcurrentDirection = 2\r\n\t\t:?direction = 4\r\n\t\t\theadX--\r\n\t\t\tcurrentDirection = 4\r\n\t\t:?direction = 6\r\n\t\t\theadX++\r\n\t\t\tcurrentDirection = 6\r\n\t\t:?direction = 8\r\n\t\t\theadY--\r\n\t\t\tcurrentDirection = 8\r\n\t\t\r\n\t\t?!inRange(headX, headY) | isBody(headX, headY)\r\n\t\t\tstartGameover()\r\n\t\t:\r\n\t\t\tspace.RemoveAt(space.IndexOf(getIndex(headX, headY)))\r\n\t\t\tshowCanvas.Set(headX * 2, headY, color, \"O\")\r\n\t\t\r\n\t\t?headX > foodX - 2 & headX < foodX + 2 & headY > foodY - 2 & headY < foodY + 2\r\n\t\t\tcc = currentLevel\r\n\t\t\t?speed = 1\r\n\t\t\t\tcc = cc * 2\r\n\t\t\tscore = score + cc\r\n\t\t\tlength++\r\n\t\t\teaten++\r\n\t\t\tsetSpeed()\r\n\t\t\tsetFood()\r\n\r\n//////////     input     //////////\r\n\r\n\r\nfunc checkInput()\r\n\t?key = bumpRBegin\r\n\t\tconfirm()\r\n\r\n\t?string.Equals(state, \"title\") | string.Equals(state, \"gameover\")\r\n\t\t?key = downBegin\r\n\t\t\tchangeInitialSpeed(-5)\r\n\t\t:?key = leftBegin\r\n\t\t\tchangeInitialSpeed(-1)\r\n\t\t:?key = rightBegin\r\n\t\t\tchangeInitialSpeed(1)\r\n\t\t:?key = upbegin\r\n\t\t\tchangeInitialSpeed(5)\r\n\t:?string.Equals(state, \"playing\")\r\n\t\t?key = down\r\n\t\t\tsetDirection(2)\r\n\t\t:?key = left\r\n\t\t\tsetDirection(4)\r\n\t\t:?key = right\r\n\t\t\tsetDirection(6)\r\n\t\t:?key = up\r\n\t\t\tsetDirection(8)\r\n\r\nfunc setDirection(d)\r\n\t?10 - d ! currentDirection\r\n\t\tdirection = d\r\n\r\nfunc confirm()\r\n\t?string.Equals(state, \"playing\")\r\n\t\tstate = \"stop\"\r\n\t:?string.Equals(state, \"stop\")\r\n\t\tstate = \"playing\"\r\n\t:?string.Equals(state, \"title\") | string.Equals(state, \"gameover\")\r\n\t\treset()\r\n\r\n//////////               //////////\r\n\r\nfunc title()\r\n\tchangeInitialSpeed(0)\r\n\tsetGuideText(\"[C] start / stop\")\r\n\tsetConfirmButton(\"start\")\r\n\r\nfunc gameover()\t\r\n\tchangeInitialSpeed(0)\r\n\tsetGuideText(\"[C] restart / stop\")\r\n\tsetConfirmButton(\"Retry\")\r\n\r\nfunc changeInitialSpeed(n)\r\n\tinitialLevel = initialLevel + n\r\n\tinitialLevel = math.clamp(initialLevel, 1, 10)\r\n\tvar t = toString(initialLevel)\r\n\tspeedChooseText.text = string.Format(ascii\r\nspeed\r\n<- {0} {1} ->\r\nasciiend,\r\n^string.sub(t, 0, 1), string.sub(t, 1, 1))\r\n\tspeedChooseText.visible = inherit\r\n\r\nfunc setGuideText(t)\r\n\tguideText.text = t\r\n\tguideText.visible = inherit\r\n\r\nfunc setConfirmButton(t)\r\n\tbuttonList[0].text = t\r\n\r\nfunc startGameover()\r\n\t?score > highestScore\r\n\t\thighestScore = score\r\n\t\tstorage.Set(\"snake_high\", highestScore)\r\n\t\thighestScoreX = mainWindow.absoluteX + mainWindow.w - numberLength(highestScore)\r\n\t\ttitleText.text = \"n e w\\n\" + score\r\n\t:\r\n\t\ttitleText.text = \"\\n\" + score\r\n\ttitleText.visible = inherit\r\n\r\n\t?headX = body[0][0] & headY = body[0][1]\r\n\t\touroboros = 0\r\n\tgameover()\r\n\tstate = \"gameover\"\r\n\r\n\r\n//////////     display score     //////////\r\n\r\nfunc displayScore()\r\n\t>`@mainWindow.absoluteX@,@mainWindow.absoluteY@,@score@\r\n\t>`@highestScoreX@,@mainWindow.absoluteY@,#rainFF,@highestScore@\r\n\r\n\t>`@mainWindow.absoluteX@,@mainWindow.absoluteY+mainWindow.h-1@,speed:@currentLevel@\r\n\r\n\r\n////////////////////////////////////////\r\nfunc inRange(x, y)\r\n\treturn x >= 0 & x < width & y >= 0 & y < height\r\n\r\nfunc isBody(x, y)\r\n\t?body.Count()\r\n\t\tfor i = 0..body.Count() - 1\r\n\t\t\t?x = body[i][0] & y = body[i][1]\r\n\t\t\t\treturn true\r\n\treturn false\r\n\r\nfunc levelCalculation(n)\r\n\treturn 11 - n\r\n\r\nfunc getIndex(x, y)\r\n\treturn width * y + x\r\n\r\nfunc numberLength(n)\r\n\t?n < 10\r\n\t\treturn 1\r\n\t:?n < 100\r\n\t\treturn 2\r\n\t:?n < 1000\r\n\t\treturn 3\r\n\t:?n < 10000\r\n\t\treturn 4\r\n\t:?n < 100000\r\n\t\treturn 5\r\n\t:?n < 1000000\r\n\t\treturn 6\r\n\r\nfunc toString(n)\r\n\tn = \"0\" + n\r\n\treturn string.sub(n, string.size(n) - 2)\r\n\r\n\r\nmain()"
